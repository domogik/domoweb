<dom-module id="dmw-c3_charts-step">
    <template id="extended-styles">
        <link rel="stylesheet" href="/widget/c3_charts/css/c3.min.css">
        <style type="text/css" is="dmw-c3-charts-step">
            :host {
                height: 100%;
                --grid-font-size: 10px;
            }
            #container {
                position: absolute;
                height: 100%;
                width: 100%;
            }
            #legend {
                position: absolute;
                bottom: 0px;
                width: 100%;
                height: calc(15%/var(--wscale-h));
                text-align: center;
            }
            #legend span {
                line-height: 100%;
            }
            #chart {
                height: 98%;
                width: 100%;
            }

/* colors */
#chart .c3-legend-item text {
/* TODO : dynamic update !!!! */
    fill: white;
    font-size: 12px;
}
#chart .c3-axis-x text {
/* TODO : dynamic update !!!! */
    fill: white;
    font-size: calc(12px*var(--wscale-w));
}
#chart .c3-axis-y text {
/* TODO : dynamic update !!!! */
    fill: white;
    font-size: calc(12px*var(--wscale-h));
}
#chart .c3-axis-x path, .c3 .c3-axis-x line {
/* TODO : dynamic update !!!! */
    stroke: white;
    stroke-width: 2px;
}
#chart .c3-axis-y path, .c3 .c3-axis-y line {
/* TODO : dynamic update !!!! */
    stroke: white;
    stroke-width: 2px;
}

#chart .c3-grid text {
    font-size: var(--grid-font-size);
}

/* width */
#chart .c3-line {
    stroke-width: 2px;
}

/* hide ticks */
#chart .c3-axis-x .tick {
   display: none;
}
        </style>
        <slot>
            <dmw-sensor id='primary' sensorkey="primary" sensorvalue="{{sensorvalue}}" sensorhistory="{{history}}"></dmw-sensor>
        </slot>
        <div id='container'>
          <div id='chart'>
          </div>
          <div id='legend'>
            <span>{{ legend }}</span>
          </div>
        </div>
    </template>
    <script src="/widget/c3_charts/js/d3.v3.min.js" charset="utf-8"></script>
    <script src="/widget/c3_charts/js/c3.min.js"></script>

    <script>
     (function () {
        let memoizedTemplate;

        class DmwC3ChartsStep extends DmwWidget {
            static get is () { return 'dmw-c3_charts-step'; }
            static get properties() {
                return {
                    sensorvalue: {
                        notify: true,
                        observer: 'sensorvalueChanged'
                    },
                    history: {
                        notify: true,
                        observer: 'historyChanged',
                    }
                }
            }
            static get template() {
              if (!memoizedTemplate) {
                // start with clone of superclass template
                memoizedTemplate = DmwWidget.template.cloneNode(true);
                // get some stuff you want to insert into super template
                const subStyle = Polymer.DomModule.import(this.is, 'template#extended-styles').content;
                // insert stuff in template after the super template's <style>
                const superStyle = memoizedTemplate.content.querySelector('style');
                superStyle.parentNode.insertBefore(subStyle, superStyle.nextSibling);
              }
              return memoizedTemplate;
            }
            connectedCallback() {
                super.connectedCallback();
                this.x = [];
                this.xlines = [];
                this.data1 = [];
            }
            resized() {
                let fSize = 10 * this.scales.height*this.scales.width;
                if (fSize < 8) { fSize = 8;
                } else if (fSize > 18) { fSize = 18; }
                this.updateStyles({
                    '--grid-font-size' : `${fSize}px`,
                });
                this.adjustText(this.$.legend, this.$.legend.children["0"]);
                if (this.chart != undefined) {
                    this.$.chart.style.maxHeight = "none";  // fixe to recaculate max-height
                    this.chart.flush();
                }
            }
            draw() {
                // color
                var the_color = "#ffffff";
                if (this.options['WidgetTextColor']  != undefined) {
                    the_color = this.options['WidgetTextColor'];
                }

                // build this.xlines for grid lines on x
                this.xlines = [];
                //var from = moment().subtract(1, 'days').startOf('day').format("%Y-%m-%d");    // copied from ../../../components/sensor.html
                for (var idx=0;idx<8;idx++) {
                    this.xlines[idx] = { value : moment().subtract(7-idx, 'days').format("YYYY-MM-DD 00:00"),
                                         text : moment().subtract(7-idx+1, 'days').format("DD/MM")}
                }


                // draw the chart
                this.chart = c3.generate({
                    bindto: this.$.chart,
                    data: {
                        x: 'x',
                        xFormat: '%Y-%m-%d %H:%M',
                        columns: [
                            this.x,
                            this.data1
                        ],
                        types: {
                            data1: 'area-step'
                        }
                    },
                    color: {
                        pattern: [the_color]
                    },
                    legend: {
                        show: false
                    },
                    tooltip: {
                        show: false
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                format: '%d/%m',
                                format: function (x) { return ''; }
                            },
                        },
                        y : {
                            tick : {
                                padding: {
                                  top: 0,
                                  bottom: 0
                                },
                                values: [0, 1]
                            },
                        }
                    },
                    grid: {
                        x: {
                            lines : this.xlines
                        }
                    },
                    point: {
                        show: false
                    }
                });
                this.chart.show(['data1']);
            }
            optionsUpdated() {
                if (this.options['hideLabels'] == true ) {
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
                //this.draw();
            }
            sensorsUpdated() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                    this.legend = this.$.primary.device['name'] + " : " + this.$.primary.name + " (last week)";
                }
                else {
                    this.legend = "--";
                }
            }
            sensorvalueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.primary.getCurrentWeekBool();

            }
            historyChanged(newValue, oldValue) {
                // in case the page is not yet nicely loaded...
                this.x = ['x'];
                this.data1 = ['data1'];
                for (var i=0; i<newValue.length; i++) {
                    this.x[i+1] = newValue[i][0] + '-' +
                                  newValue[i][1] + '-' +
                                  ("0" + newValue[i][3]).slice(-2) + ' ' +
                                  newValue[i][4] + ':00';
                    //this.x[i+1] = i+1;
                    this.data1[i+1] = newValue[i][5];
                    /*
                    if (newValue[i][4] == 0) {
                        this.xlines.push({ value : this.x[i+1], text : this.x[i+1]})
                    }
                    */
                }
                this.draw();
            }
        };
        customElements.define(DmwC3ChartsStep.is, DmwC3ChartsStep);
    })();
    </script>
</dom-module>
