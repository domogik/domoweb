<dom-module id="dmw-c3_charts-spline">
    <template id="extended-styles">
        <link rel="stylesheet" href="/widget/c3_charts/css/common.css">
        <link rel="stylesheet" href="/widget/c3_charts/css/c3.min.css">
        <style type="text/css" is="dmw-c3-charts-spline">
            :host {
                height: 100%;
            }
            #container {
                position: absolute;
                height: 100%;
                width: 100%;
            }
            #legend {
                position: absolute;
                bottom: 0px;
                width: 100%;
                font-size: 1.3em;
                text-align: center;
            }
            #chart {
                height: 98%;
                width: 100%;
            }

/* colors */
#chart .c3-legend-item text {
/* TODO : dynamic update !!!! */
    fill: white;
    font-size: 12px;
}
#chart .c3-axis-x text {
/* TODO : dynamic update !!!! */
    fill: white;
    font-size: 12px;
}
#chart .c3-axis-y text {
/* TODO : dynamic update !!!! */
    fill: white;
    font-size: 12px;
}
#chart .c3-axis-x path, .c3 .c3-axis-x line {
/* TODO : dynamic update !!!! */
    stroke: white;
    stroke-width: 2px;
}
#chart .c3-axis-y path, .c3 .c3-axis-y line {
/* TODO : dynamic update !!!! */
    stroke: white;
    stroke-width: 2px;
}

/* width */
#chart .c3-line {
    stroke-width: 2px;
}

/* hide ticks */
#chart .c3-axis-x .tick {
   display: none;
}

        </style>
        <dmw-sensor id='primary' sensorkey="primary" sensorvalue="{{sensorvalue}}" sensorhistory="{{history}}"></dmw-sensor>
        <shadow></shadow>
        <div id='container'>
          <div id='chart'>
          </div>
          <div id='legend'>
            {{ legend }}
          </div>
        </div>
    </template>
    <script src="/widget/c3_charts/js/d3.v3.min.js" charset="utf-8"></script>
    <script src="/widget/c3_charts/js/c3.min.js"></script>

    <script>
     (function () {
        let memoizedTemplate;

        class DmwC3ChartsSpline extends DmwWidget {
            static get is () { return 'dmw-c3_charts-spline'; }
            static get properties() {
                return {
                    sensorvalue: {
                        notify: true,
                        observer: 'sensorvalueChanged'
                    },
                    history: {
                        notify: true,
                        observer: 'historyChanged',
                    }
                }
            }
            static get template() {
              if (!memoizedTemplate) {
                // start with clone of superclass template
                memoizedTemplate = DmwWidget.template.cloneNode(true);
                // get some stuff you want to insert into super template
                const subStyle = Polymer.DomModule.import(this.is, 'template#extended-styles').content;
                // insert stuff in template after the super template's <style>
                const superStyle = memoizedTemplate.content.querySelector('style');
                superStyle.parentNode.insertBefore(subStyle, superStyle.nextSibling);
              }
              return memoizedTemplate;
            }
            connectedCallback() {
                super.connectedCallback();
                this.x = [];
                this.xlines = [];
                this.data1 = [];
            }
            draw() {
                // color
                var the_color = "#ffffff";
                if (this.options['WidgetTextColor']  != undefined) {
                    the_color = this.options['WidgetTextColor'];
                }

                // build this.xlines for grid lines on x
                this.xlines = [];
                //var from = moment().subtract(1, 'weeks').startOf('day').format("%Y-%m-%d");    // copied from ../../../components/sensor.html
                for (var idx=0;idx<8;idx++) {
                    this.xlines[idx] = { value : moment().subtract(7-idx, 'days').format("YYYY-MM-DD 00:00"),
                                         text : moment().subtract(7-idx+1, 'days').format("DD/MM")};
                }


                // draw the chart
                this.chart = c3.generate({
                    bindto: this.$.chart,
                    data: {
                        x: 'x',
                        xFormat: '%Y-%m-%d %H:%M',
                        columns: [
                            this.x,
                            this.data1
                        ],
                        types: {
                            data1: 'area-spline'
                        }
                    },
                    color: {
                        pattern: [the_color]
                    },
                    legend: {
                        show: false
                    },
                    tooltip: {
                        show: false
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                format: '%d/%m',
                                format: function (x) { return ''; }
                            },
                        },
                        y : {
                            min: parseInt(this.options['chartMinValue']),
                            max: parseInt(this.options['chartMaxValue'])
                        }
                    },
                    grid: {
                        x: {
                            lines : this.xlines
                        }
                    },
                    point: {
                        show: false
                    },
                    area: {
                        zerobased: false
                    }
                });
                this.chart.show(['data1']);
            }
            optionsUpdated() {
                if (this.options['hideLabels'] == true ) {
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
                //this.draw();
            }
            sensorsUpdated() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                    this.legend = this.$.primary.device['name'] + " : " + this.$.primary.name + " (last week)";
                }
                else {
                    this.legend = "--";
                }
            }
            sensorvalueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.primary.getCurrentWeek();

            }
            historyChanged(newValue, oldValue) {
                // in case the page is not yet nicely loaded...
                this.x = ['x'];
                this.data1 = ['data1'];
                for (var i=0; i<newValue.length; i++) {
                    this.x[i+1] = newValue[i][0] + '-' +
                                  newValue[i][1] + '-' +
                                  ("0" + newValue[i][3]).slice(-2) + ' ' +
                                  newValue[i][4] + ':00';
                    //this.x[i+1] = i+1;
                    this.data1[i+1] = newValue[i][5];
                    /*
                    if (newValue[i][4] == 0) {
                        this.xlines.push({ value : this.x[i+1], text : this.x[i+1]})
                    }
                    */
                }
                this.draw();
            }
        };
        customElements.define(DmwC3ChartsSpline.is, DmwC3ChartsSpline);
    })();
    </script>
</dom-module>
