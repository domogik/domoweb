/* NEW 2.0 */
<style>
@font-face {
  font-family: 'weathericons';
  src: url('/widget/weather/weather-icons-master-2.0/font/weathericons-regular-webfont.eot');
  src: url('/widget/weather/weather-icons-master-2.0/font/weathericons-regular-webfont.eot?#iefix') format('embedded-opentype'), url('/widget/weather/weather-icons-master-2.0/font/weathericons-regular-webfont.woff2') format('woff2'), url('/widget/weather/weather-icons-master-2.0/font/weathericons-regular-webfont.woff') format('woff'), url('/widget/weather/weather-icons-master-2.0/font/weathericons-regular-webfont.ttf') format('truetype'), url('/widget/weather/weather-icons-master-2.0/font/weathericons-regular-webfont.svg#weather_iconsregular') format('svg');
  font-weight: normal;
  font-style: normal;
}
</style>
<dom-module id="dmw-weather-vigilance3">
    <template id="extended-styles">
        <link rel="stylesheet" href="/widget/weather/weather-icons-master-2.0/css/weather-icons.min.css">
        <style type="text/css">
            :host {
                height: 100%;
                display: block;
                --map-size : 92px;
                --picto-width: 36px;
                --picto-height: 20px;
            }
            #maincontainer {
                width: 100%;
                height: 100%;
                overflow: hidden;
                border-radius: var(--WidgetBorderRadius, 15px);
            }
            #container {
                height: var(--map-size);
                position: relative;
                background: #1a1a00 ;
            }
            #image {
              position: absolute;
              left: 0;
              top: 0;
              width: var(--map-size);
              height: var(--map-size);
            }
            #image2 {
                left: 263;
                top: 0;
                float: right;
                /*width: calc(45px*var(--wscale-h));
                height: calc(45px*var(--wscale-h));*/
                width: var(--map-size);
                height: var(--map-size);
            }
            #date {
              z-index: 100;
              position: absolute;
              color: white;
              font-size: 6px;
              left: 72px;
              top: 2px;
            }
            #title {
                position: absolute;
                color: white;
                /*background-color: #D8D8D8;*/
                background-color: #323639;
                left: var(--map-size);
                /*width: calc(100% - var(--map-size) - (45px*var(--wscale-h))); */
                width: calc(100% - var(--map-size) * 2);
                font-size: calc(14px*var(--wscale-h)*var(--wscale-r));
                font-weight: bold;
                text-align: center;
             }
            #text {
              z-index: 5;
              width: calc(100% - var(--map-size) - (45px*var(--wscale-h)));
              position: absolute;
              color: black;
              font-size: calc(24px*var(--wscale-h)*var(--wscale-r));
              font-weight: bold;
              left: calc(5px + var(--map-size));
              top:  calc(20px*var(--wscale-h)*var(--wscale-r));
              }

            #pictoM {
                float: left;
                width: var(--picto-width);
                background: #1a1a00 ;
                font-size: calc(20px*var(--wscale-h)*var(--wscale-r));
                height: auto;
                color: white ;
                text-align : center;
                line-height: var(--picto-height);
            }
            #pictoM :hover{
                cursor: pointer;
            }
            #pictoM .tooltiptext {
                visibility: hidden;
                background-color: white;
                color: black;
                text-align: center;
                font-size: 14px;
                border-radius: 6px;
                padding: 5px 20px;
                margin-left: -80px;
                margin-top: -30px;
                position: absolute;
                z-index: 999;
            }
            #pictoM:active .tooltiptext {
                visibility: visible;
            }
            #info {
                background-color: #808080;
                position: absolute;
                display: none;
                top: 0px;
                left: 0px;
                min-height: 100%;
                width: 100%;
                padding: 0;
                z-index: 5;
            }
            #infotext {
                position: absolute;
                width: 96%;
                height: 92%;
                margin: 2%;
                font-size: calc(20px*var(--wscale-h)*var(--wscale-r));
                text-align: center;
            }
        </style>

        <slot>
            <dmw-sensor id='vigilanceDep' sensorkey="vigilanceDep" sensorvalue="{{vigilanceDep_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColor' sensorkey="vigilanceColor" sensorvalue="{{vigilanceColor_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorWind' sensorkey="vigilanceColorWind" sensorvalue="{{vigilanceColorWind_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorRain' sensorkey="vigilanceColorRain" sensorvalue="{{vigilanceColorRain_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorThunderstorms' sensorkey="vigilanceColorThunderstorms" sensorvalue="{{vigilanceColorThunderstorms_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorFlood' sensorkey="vigilanceColorFlood" sensorvalue="{{vigilanceColorFlood_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorSnow' sensorkey="vigilanceColorSnow" sensorvalue="{{vigilanceColorSnow_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorHeat' sensorkey="vigilanceColorHeat" sensorvalue="{{vigilanceColorHeat_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorCold' sensorkey="vigilanceColorCold" sensorvalue="{{vigilanceColorCold_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorAvalanches' sensorkey="vigilanceColorAvalanches" sensorvalue="{{vigilanceColorAvalanches_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceColorSubmersion' sensorkey="vigilanceColorSubmersion" sensorvalue="{{vigilanceColorSubmersion_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceRisk' sensorkey="vigilanceRisk" sensorvalue="{{vigilanceRisk_value}}"></dmw-sensor>
            <dmw-sensor id='vigilanceInfo' sensorkey="vigilanceInfo" sensorvalue="{{vigilanceInfo_value}}"></dmw-sensor>
        </slot>

        <div id="maincontainer">
            <div id="container" on-click="displayInfo">
                <!-- <img id="image" src="{{urlVigiFrance}}" on-click="{{displayInfo}}/> -->
                <img id="image" src="{{urlVigiFrance}}" />
                <!-- <span id="date">{{ date }}</span> -->
                <div id="title">{{ title }}</div>
                <span id="text">{{ risk }}</span>
                <img id="image2" src="/widget/weather/images/vigilance/logo.png" />
            </div>
            <div id="piccontainer">
                <div id="pictoM"><div id="riskWind"><i class="wi wi-strong-wind"></i></div><span class="tooltiptext">{{ tooltipWind }}</span></div>
                <div id="pictoM"><div id="riskRain"><i class="wi wi-rain"></i></div><span class="tooltiptext">{{ tooltipRain }}</span></div>
                <div id="pictoM"><div id="riskThunderstorms"><i class="wi wi-lightning"></i></div><span class="tooltiptext">{{ tooltipThunderstorms }}</span></div>
                <div id="pictoM"><div id="riskFlood"><i class="wi wi-flood"></i></div><span class="tooltiptext">{{ tooltipFlood }}</span></div>
                <div id="pictoM"><div id="riskSnow"><i class="wi wi-snow"></i></div><span class="tooltiptext">{{ tooltipSnow }}</span></div>
                <div id="pictoM"><div id="riskHeat"><i class="wi wi-day-sunny"></i></div><span class="tooltiptext">{{ tooltipHeat }}</span></div>
                <div id="pictoM"><div id="riskCold"><i class="wi wi-snowflake-cold"></i></div><span class="tooltiptext">{{ tooltipCold }}</span></div>
                <div id="pictoM"><div id="riskAvalanches"><i class="wi wi-volcano"></i></div><span class="tooltiptext">{{ tooltipAvalanches }}</span></div>
                <div id="pictoM"><div id="riskSubmersion"><i class="wi wi-tsunami"></i></div><span class="tooltiptext">{{ tooltipSubmersion }}</span></div>
            </div>
            <div id="info" on-click="hideInfo"><pre id=infotext>{{ vigiInfo }}</pre></div>
        </div>
    </template>

    <script>
     (function () {
        let memoizedTemplate;

        class DmwWeatherVigilance3 extends DmwWidget {
            static get is () { return 'dmw-weather-vigilance3'; }
            static get properties() {
                return {
                    vigilanceDep_value: {
                        notify: true,
                        observer: 'vigilanceDep_valueChanged'
                    },
                    vigilanceColor_value: {
                        notify: true,
                        observer: 'vigilanceColor_valueChanged',
                    },
                    vigilanceColorWind_value: {
                        notify: true,
                        observer: 'vigilanceColorWind_valueChanged',
                    },
                    vigilanceColorRain_value: {
                        notify: true,
                        observer: 'vigilanceColorRain_valueChanged',
                    },
                    vigilanceColorThunderstorms_value: {
                        notify: true,
                        observer: 'vigilanceColorThunderstorms_valueChanged',
                    },
                    vigilanceColorFlood_value: {
                        notify: true,
                        observer: 'vigilanceColorFlood_valueChanged',
                    },
                    vigilanceColorSnow_value: {
                        notify: true,
                        observer: 'vigilanceColorSnow_valueChanged',
                    },
                    vigilanceColorHeat_value: {
                        notify: true,
                        observer: 'vigilanceColorHeat_valueChanged',
                    },
                    vigilanceColorCold_value: {
                        notify: true,
                        observer: 'vigilanceColorCold_valueChanged',
                    },
                    vigilanceColorAvalanches_value: {
                        notify: true,
                        observer: 'vigilanceColorAvalanches_valueChanged',
                    },
                    vigilanceColorSubmersion_value: {
                        notify: true,
                        observer: 'vigilanceColorSubmersion_valueChanged',
                    },
                    vigilanceRisk_value: {
                        notify: true,
                        observer: 'vigilanceRisk_valueChanged',
                    },
                    vigilanceInfo_value: {
                        notify: true,
                        observer: 'vigilanceInfo_valueChanged',
                    }
                }
            }
            static get template() {
              if (!memoizedTemplate) {
                // start with clone of superclass template
                memoizedTemplate = DmwWidget.template.cloneNode(true);
                // get some stuff you want to insert into super template
                const subStyle = Polymer.DomModule.import(this.is, 'template#extended-styles').content;
                // insert stuff in template after the super template's <style>
                const superStyle = memoizedTemplate.content.querySelector('style');
                superStyle.parentNode.insertBefore(subStyle, superStyle.nextSibling);
              }
              return memoizedTemplate;
            }
            constructor() {
                super();
                this.ratioConstraint = 'width';
            }
            languageLoaded() {
                this.tooltipWind = this.localize("weather:Wind") ;
                this.tooltipRain = this.localize("weather:Rain") ;
                this.tooltipThunderstorms = this.localize("weather:Thunderstorms") ;
                this.tooltipFlood= this.localize("weather:Flood") ;
                this.tooltipSnow = this.localize("weather:Snow/ice") ;
                this.tooltipHeat = this.localize("weather:Heat wave") ;
                this.tooltipCold = this.localize("weather:Intense cold") ;
                this.tooltipAvalanches = this.localize("weather:Avalanches") ;
                this.tooltipSubmersion = this.localize("weather:Submersion wave") ;
            }
            resized() {
                const pictoW = this.clientWidth / 9;
                const pictoH = pictoW * (20/29);
                const mapSize = this.clientHeight - pictoH;
                this.updateStyles({
                    "--map-size": mapSize+"px",
                    "--picto-width": pictoW+"px",
                    "--picto-height": pictoH+"px",
                    });
                this._computeFontInfo();
            }
            vigilanceDep_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.title = "Département " + newValue ;
                this.urlVigiFrance = "http://vigilance.meteofrance.com/data/QGFR08_LFPW_.gif?" + new Date().getTime();
            }
            vigilanceInfo_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.vigiInfo = newValue ;
                var vigiInfoLines = this.vigiInfo.split("\n") ;
                this.date = vigiInfoLines[1] ;

            }
            vigilanceColor_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.text.style.color = getColor(newValue) ;
            }
            vigilanceColorWind_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskWind.style.color = getColor(newValue) ;
            }
            vigilanceColorRain_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskRain.style.color = getColor(newValue) ;
            }
            vigilanceColorThunderstorms_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskThunderstorms.style.color = getColor(newValue) ;
            }
            vigilanceColorFlood_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskFlood.style.color = getColor(newValue) ;
            }
            vigilanceColorSnow_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskSnow.style.color = getColor(newValue) ;
            }
            vigilanceColorHeat_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskHeat.style.color = getColor(newValue) ;
            }
            vigilanceColorCold_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskCold.style.color = getColor(newValue) ;
            }
            vigilanceColorAvalanches_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskAvalanches.style.color = getColor(newValue) ;
            }
            vigilanceColorSubmersion_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                this.$.riskSubmersion.style.color = getColor(newValue) ;
            }
            vigilanceRisk_valueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;

                if (newValue) {
                    var riskslist = newValue.split(",") ;
                    var riskslistlen = riskslist.length ;
                    var risktext = "" ;
                    for (var i = 0; i < riskslistlen; i++) {
                        risktext = risktext + this.localize("weather:" + riskslist[i]) + "<br>" ;
                    }
                    this.$.text.innerHTML = risktext;
                    this._computeFontInfo();
                }
            }

            _computeFontInfo() {
                const risktext = this.$.text.innerHTML;
                if (risktext) {
                    const riskslistlen = risktext.split("<br>").length;
                    this.$.text.style.fontSize = parseInt(((7 - riskslistlen) * 4) * this.scales.height * this.scales.constraintRatio) + "px";
                }
            }

            displayInfo() {
                console.error("displayInfo = " + this.vigiInfo);
                this.$.info.style.display = "block";
            }
            hideInfo() {
                console.error("hideInfo");
                this.$.info.style.display = "none";
            }
	    };

        function getColor(color) {
            switch(color) {         // "white", "green", "yellow", "orange", "red"
                case 'W':
                    return "white" ;
                case 'G':
                    return "#31B404" ;
                case 'Y':
                    return "yellow" ;
                case 'O':
                    return "orange" ;
                case 'R':
                    return "red" ;
                default:
                    return "white" ;
            }
        }
        customElements.define(DmwWeatherVigilance3.is, DmwWeatherVigilance3);
    })();
    </script>
</dom-module>
