<script src="/widget/gauges/js/gauge-fix-fritz.js"></script>
<link rel="import" href="/libraries/bower_components/sc-fitted-text/sc-fitted-text.html">

<dom-module id="dmw-gauges-gauge1">
    <template id="extended-styles">
        <style type="text/css">
            :host {
                height: 100%;
                display: block;
            }
            #content {
                height: 100%;
                width: 100%;
            }
            #gauge {
                position: relative;
                width: 110%;
                height: 60%;
                top: 30%;
                -webkit-transform: translate(-50%, -50%);
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                left: 50%;
                text-align: center;
                overflow: hidden;
                display: inline-block;
            }
            #number {
                position: absolute;
                bottom: 25%;
                -webkit-transform: translate(0%, 50%);
                -ms-transform: translate(0%, 50%);
                transform: translate(0%, 50%);
                text-align: center;
                overflow: hidden;
                display: inline-block;
                padding: 10px;
                width: 100%;
                height: 40%
            }
            #numVal {
                display: flex;
                align-items: center;
                height: 100%;
            }
            #unit {
                position: absolute;
                top:5px;
                right: 5px;
                font-size: 1em;
            }
        </style>
        <dmw-sensor id='primary' sensorkey="primary" sensorvalue={{sensorvalue}} sensornotified="number"></dmw-sensor>
        <shadow></shadow>
        <div id="content">
            <canvas id="gauge"></canvas>
            <div id='number'>
                <sc-fitted-text id="numVal" align="center" max-width="[[numMaxWidth]]" text="[[number]]"></sc-fitted-text>
            </div>
            <div id='unit'>[[unit]]</div>
        </div>
    </template>
    <script>
     (function () {
        let memoizedTemplate;

        class DmwGaugesGauge1 extends DmwWidget {
            static get is () { return 'dmw-gauges-gauge1'; }
            static get properties() {
                return {
                    sensorvalue: {
                        notify: true,
                        observer: 'sensorvalueChanged'
                    }
                }
            }
            static get template() {
              if (!memoizedTemplate) {
                // start with clone of superclass template
                memoizedTemplate = DmwWidget.template.cloneNode(true);
                // get some stuff you want to insert into super template
                const subStyle = Polymer.DomModule.import(this.is, 'template#extended-styles').content;
                // insert stuff in template after the super template's <style>
                const superStyle = memoizedTemplate.content.querySelector('style');
                superStyle.parentNode.insertBefore(subStyle, superStyle.nextSibling);
              }
              return memoizedTemplate;
            }
            constructor() {
                super();
            }
            connectedCallback() {
                super.connectedCallback();
                this.number = "--";
                this.unit = "";
            }
            resized() {
                const width = parseInt(this.getAttribute('width'));
                const height = parseInt(this.getAttribute('height'));
                let uSize = '1em';
                if (width > 1) { uSize = '2em'; }
                if (width > 3) { uSize = '3em'; }
                this.$.unit.style.fontSize = uSize;
                this.$.numVal.style.fontSize = `${this.$.number.clientHeight}px`;
                this.numMaxWidth =  this.$.number.clientWidth;
            }
            optionsUpdated() {
                if (this.options['hideLabels'] == true ) {
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
            }
            sensorsUpdated() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                }
            }
            sensorvalueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                var unit = this.datatypes[this.$.primary.datatype_id]['unit'];
                if (this.options['autoconvert']==1 && newValue > 0) {
                       var k = 1000;
                       var sizes = ['', 'K', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'];
                       var i = Math.floor(Math.log(newValue) / Math.log(k));
                   // this.$.numVal.innerHTML = (newValue / Math.pow(k, i)).toPrecision(3);
                    this.number = (newValue / Math.pow(k, i)).toPrecision(3);
                    if (unit) {
                        this.unit = sizes[i] + this.localize("domoweb:unit","value", unit );
                    }
                } else {
                    if (newValue) {
                      //  this.$.numVal.innerHTML = newValue;
                        this.number = newValue;
                    } else {
                        this.number = '?';
                   //     this.$.numVal.innerHTML = "<i class='fa fa-exclamation-triangle' aria-hidden='true' style='color:red;'></i>";
                        newValue = 0;
                    }
                    if (unit) {
                        this.unit = this.localize("domoweb:unit", "value", unit );
                    }
                }
          //      this.adjustText(this, this.$.numVal, {width :5, height:0});

                if (this.options['colorProfile'] == "temperature") {
                    var colorProfile = [[0.0, "#1424fd" ], [0.25, "#e9ecff"], [0.5, "#f8fe9a"], [0.75, "#f9aa4b"], [1.0, "#fc2008"]];
                }
                else {  // include the "classic" value
                    var colorProfile = [[0.0, "#a9d70b" ], [0.50, "#f9c802"], [1.0, "#ff0000"]];
                }
                var opts = {
                  lines: 12,
                  angle: 0.0,
                  lineWidth: 0.44,
                  pointer: {
                    length: 0.7,
                    strokeWidth: 0.035,
                    color: '#000000'
                  },
                  limitMax: 'false',
                  //percentColors: [[0.0, "#a9d70b" ], [0.50, "#f9c802"], [1.0, "#ff0000"]], // !!!!
                  percentColors: colorProfile,
                  strokeColor: '#E0E0E0',
                  generateGradient: true
                };
                this.gauge = new Gauge(this.$.gauge).setOptions(opts);
                this.gauge.minValue = parseFloat(this.options['minValue']);
                this.gauge.maxValue = parseFloat(this.options['maxValue']);
                this.gauge.animationSpeed = 32;

                // Avoid a library bug with newValue == 0....
                if (newValue == 0) newValue = 0.0001;

                if (newValue <= this.gauge.minValue) {
                    this.gauge.set(this.gauge.minValue + 0.0001);
                }
                else if (newValue >= this.gauge.maxValue) {
                    this.gauge.set(this.gauge.maxValue);
                }
                else {
                    this.gauge.set(newValue);
                }

            }
        };
    customElements.define(DmwGaugesGauge1.is, DmwGaugesGauge1);
    })();
    </script>
</dom-module>
