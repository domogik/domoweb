<dom-module id="dmw-basic-sensornumber">
    <template id="extended-styles">
        <style type="text/css">
            :host {
                height: 100%;
                display: block;
            }
            #number {
                position: relative;
                top: 50%;
                -webkit-transform: translate(-50%, -50%);
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                left: 50%;
                text-align: center;
                overflow: hidden;
                display: inline-block;
                padding: 10px;
            }
            #unit {
                position: absolute;
                top:5px;
                right: 5px;
                font-size: calc(1em*var(--wscale-h)*var(--wscale-r));
            }
        </style>
        <dmw-sensor id='primary' sensorkey="primary" sensorvalue="{{sensorvalue}}" sensornotified="number"></dmw-sensor>
        <div id='number'>{{number}}</div>
        <div id='unit'>{{unit}}</div>
    </template>
    <script>
     (function () {
        let memoizedTemplate;

        class DmwBasicSensorNumber extends DmwWidget {
            static get is () { return 'dmw-basic-sensornumber'; }
            static get properties() {
                return {
                    sensorvalue: {
                        notify: true,
                        observer: 'sensorvalueChanged'
                    }
                }
            }
            static get template() {
              if (!memoizedTemplate) {
                // start with clone of superclass template
                memoizedTemplate = DmwWidget.template.cloneNode(true);
                // get some stuff you want to insert into super template
                const subStyle = Polymer.DomModule.import(this.is, 'template#extended-styles').content;
                // insert stuff in template after the super template's <style>
                const superStyle = memoizedTemplate.content.querySelector('style');
                superStyle.parentNode.insertBefore(subStyle, superStyle.nextSibling);
              }
              return memoizedTemplate;
            }
            constructor() {
                super();
                this.ratioConstraint = 'width';
            }
            connectedCallback() {
                super.connectedCallback();
                this.number = "--";
                this.unit = "";
            }
            resized () {
                this.adjustText(this, this.$.number);
            }
            optionsUpdated() {
                if (this.options['hideLabels'] == true ) {
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
            }
            sensorsUpdated() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                }
            }
            sensorvalueChanged(newValue, oldValue) {
                newValue = newValue.stored_value;
                if (!Number.isInteger(newValue)) {
                    newValue = parseFloat(newValue).toFixed(this.options['precision']);
                }
                var unit = this.datatypes[this.$.primary.datatype_id]['unit'];
                if (this.options['autoconvert']==1 && newValue > 0) {
                       var k = 1000;
                       var sizes = ['', 'K', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'];
                       var i = Math.floor(Math.log(newValue) / Math.log(k));
                    this.$.number.innerHTML = (newValue / Math.pow(k, i)).toPrecision(3);
                    if (unit) {
                        this.unit = sizes[i] + this.localize("domoweb:unit", "value", unit );
                    }
                } else {
                    this.$.number.innerHTML = newValue;
                    if (unit) {
                        this.unit = this.localize("domoweb:unit", "value", unit );
                    }
                }
                this.adjustText(this, this.$.number);
            }
	    };
        customElements.define(DmwBasicSensorNumber.is, DmwBasicSensorNumber);
    })();
    </script>
</dom-module>
