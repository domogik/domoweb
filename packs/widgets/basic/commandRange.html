<link rel="import" href="/libraries/bower_components/paper-slider/paper-slider.html">

<dom-module id="dmw-basic-commandrange">
    <template id="extended-styles">
        <style type="text/css">
            :host {
                height: 100%;
                width: 100%;
            }
            #range {
                --paper-slider-height : calc(15px*var(--wscale-h));
                --paper-slider-knob-size: calc(20px*var(--wscale-h));
                --paper-slider-knob-start-color: var(--paper-grey-400);
                --paper-slider-knob-start-border-color: var(--paper-grey-200);
                position: relative;
                height: 100%;
                width: 100%;
           }
           </style>
        <dmw-command id="primary" commandkey="primary" commandnotified="range"></dmw-command>
        <dmw-sensor id='scalingstate' sensorkey="scalingstate" sensorvalue={{scalingstate}} sensornotified="range"></dmw-sensor>
        <paper-slider id="range" pin min=[[rangeMinValue]] max=[[rangeMaxValue]]></paper-slider>
    </template>
    <script>
     (function () {
        let memoizedTemplate;

        class DmwBasicCommandRange extends DmwWidget {
            static get is () { return 'dmw-basic-commandrange'; }
            static get properties() {
                return {
                    scalingstate: {
                        notify: true,
                        observer: 'scalingstateChanged'
                    }
                }
            }            static get template() {
              if (!memoizedTemplate) {
                // start with clone of superclass template
                memoizedTemplate = DmwWidget.template.cloneNode(true);
                // get some stuff you want to insert into super template
                const subStyle = Polymer.DomModule.import(this.is, 'template#extended-styles').content;
                // insert stuff in template after the super template's <style>
                const superStyle = memoizedTemplate.content.querySelector('style');
                superStyle.parentNode.insertBefore(subStyle, superStyle.nextSibling);
              }
              return memoizedTemplate;
            }
            constructor() {
                super();
            }
            connectedCallback() {
                super.connectedCallback();

            }
            optionsUpdated() {
                if (this.options['hideLabels'] == true ) {
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
                if (this.options['rangeMinValue']) {
                    this.$.range.min = this.options['rangeMinValue'];
                }
                if (this.options['rangeMaxValue']) {
                    this.$.range.max = this.options['rangeMaxValue'];
                }
                this.$.range.min =  parseFloat(this.$.range.min);
                this.$.range.max = parseFloat(this.$.range.max);
            }
            sensorsUpdated() {
                if (this.$.scalingstate.isSet) {
                    this.hasFeedback = true;
                } else {
                    this.current = 0;
                    this.$.range.value = 0;
                }
            }
            commandsUpdated() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                    this.$.range.addEventListener('change', this.onInput.bind(this));
                    this.$.range.$.sliderKnob.style.cursor = 'pointer';
                }
            }
            scalingstateChanged(newValue, oldValue) {
                this.current = parseFloat(newValue.stored_value);
                var val = (this.$.range.value - this.$.range.min) / (this.$.range.max - this.$.range.min);
                this.updateStyles({
                    '--paper-slider-active-color': 'blue'
                    });
                this.$.range.value = this.current;
            }
            onInput(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("OnInput : " + this.$.range.value);
                this.prevalue = this.$.range.value;
                var parameters = {};
                parameters[this.$.primary.parameters[0]['key']] = this.$.range.value;
                this.$.primary.send(parameters);
                this.prevalue = "";
                var val = (this.$.range.value - this.$.range.min) / (this.$.range.max - this.$.range.min);
                this.updateStyles({
                    '--paper-slider-active-color': 'red'
                    });
            }
        };
        customElements.define(DmwBasicCommandRange.is, DmwBasicCommandRange);
    })();
    </script>
</dom-module>
