<link rel="import" href="/libraries/bower_components/polymer/polymer.html">
<link rel="import" href="/components/sensor.html">
<link rel="import" href="/components/command.html">
<link rel="import" href="/libraries/bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="/libraries/bower_components/bootstrap-styles/bootstrap-styles.html">
<link rel="import" href="/libraries/bower_components/slate-font-awesome/slate-font-awesome.html">
<link rel="import" href="/libraries/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/widget/basic/css/labelstyles.html">

<dom-module id="dmw-widget">
	<template>
        <style include="bootstrap-styles"></style>
        <style include="slate-font-awesome"></style>
        <style include="dmw-widget-label-styles"></style>
		<style type="text/css">
		:host {
			height: 100%;
			width: 100%;
			display: block;
			max-width:100%;
            --wscale-w: 1;
            --wscale-h: 1;
            --wscale-r: 1;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
            --sensor-notify-color-rgb: 51,255,51;
            --command-notify-color-rgb: 255,51,204;
		}
		#editOverlay {
			color: #f0f0F0;
			position: absolute;
			background-color: rgba(0,0,0,0.6);
			top: -1px;
			left: -1px;
			bottom: -1px;
			right: -1px;
			z-index: 9;
			display: none;
		    justify-content: center;
		    align-items: center;
            cursor:move;
		}

		#editOverlay.visible {
			display: flex
		}

		#editOverlay button {
			display: flex;
		    justify-content: center;
		    align-items: center;
			background: #000000;
            color: #f0f0F0;
			display: block;
			width: 2em;
			height: 2em;
			border: 1px solid #f0f0F0;
			-moz-border-radius: 1em;
			-webkit-border-radius: 1em;
			border-radius: 1em;
            z-index: 15;
		}

        #editOverlay > span:not([resize]) {
            flex: 1;
            text-align: center;
            font-size: 2em;
        }
        #editOverlay [resize] {
            position: absolute;
        }

        #editOverlay [resize="bottom-right"] {
            bottom: 0;
            right: 0;
            cursor: nwse-resize;
        }

        #editOverlay [resize="bottom-left"] {
            bottom: 0;
            left: 0;
            cursor: nesw-resize;
        }

        #editOverlay [resize="top-right"] {
            top: 0;
            right: 0;
            cursor: nesw-resize;
        }

        #editOverlay [resize="top-left"] {
            top: 0;
            left: 0;
            cursor: nwse-resize;
        }

        #editOverlay [resize="left"] {
            top: 50%;
            left: 0;
            cursor: ew-resize;
            margin-top: -10px;
        }

        #editOverlay [resize="top"] {
            top: 0%;
            width: 100%;
            text-align: center;
            cursor: ns-resize;
        }

        #editOverlay [resize="right"] {
            top: 50%;
            right: 0;
            cursor: ew-resize;
            margin-top: -10px;
        }

        #editOverlay [resize="bottom"] {
            bottom: 0;
            width: 100%;
            text-align: center;
            cursor: ns-resize;
        }

		#editOverlay button:hover,
		#editOverlay button:focus {
			background: #f0f0F0;
			color: #000000;
		}
		#editOverlay .editWidget {
            position: absolute;
            top: 5%;
            left: 5%;
        }
		#editOverlay .removeWidget {
            position: absolute;
            bottom: 5%;
            right: 5%;
        }
        #editOverlay .tipsize {
            --paper-tooltip-background: transparent;
            --paper-tooltip-opacity: 0.6;
            width: 100px;
        }
        #editOverlay .info{
            display: inline-grid;
            background-color: black;
            padding: 6px;
			-moz-border-radius: 1em;
			-webkit-border-radius: 1em;
            border-radius: 1em;
        }
        #editOverlay .info span{
            padding: 2px;
        }
		#timeoutOverlay {
			position: absolute;
			top:50%;
			display: none;
			/*background: #99312C;*/
			background-color: rgba(153, 49, 44, 0.85);
			color: #ffffff;
			z-index: 8;
			width: 100%;
			text-align: center;
			line-height: 1.4em;
			margin-top:-1.4em;
		}

        .pulse-sensor {
              border: none;
              box-shadow: 0 0 0 0 rgba(var(--sensor-notify-color-rgb),0.7);
              -webkit-animation: sensorpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
              -moz-animation: sensorpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
              -ms-animation: sensorpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
              animation: sensorpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
            }
        @-webkit-keyframes sensorpulse {from {box-shadow: 0 0 0 30px rgba(var(--sensor-notify-color-rgb),0);}}
        @-moz-keyframes sensorpulse {from {box-shadow: 0 0 0 30px rgba(var(--sensor-notify-color-rgb),0);}}
        @-ms-keyframes sensorpulse {from {box-shadow: 0 0 0 30px rgba(var(--sensor-notify-color-rgb),0);}}
        @keyframes sensorpulse {from {box-shadow: 0 0 0 30px rgba(var(--sensor-notify-color-rgb),0);}}

        .pulse-cmd {
              border: none;
              box-shadow: 0 0 0 0 rgba(var(--command-notify-color-rgb),0.7);
              -webkit-animation: cmdpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
              -moz-animation: cmdpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
              -ms-animation: cmdpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
              animation: cmdpulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
            }
        @-webkit-keyframes cmdpulse {from {box-shadow: 0 0 0 30px rgba(var(--command-notify-color-rgb),0);}}
        @-moz-keyframes cmdpulse {from {box-shadow: 0 0 0 30px rgba(var(--command-notify-color-rgb),0);}}
        @-ms-keyframes cmdpulse {from {box-shadow: 0 0 0 30px rgba(var(--command-notify-color-rgb),0);}}
        @keyframes cmdpulse {from {box-shadow: 0 0 0 30px rgba(var(--command-notify-color-rgb),0);}}		</style>
		<web-socket id="socket"></web-socket>
		<polymer-ajax id="ajax" method="POST" url="/configuration"></polymer-ajax>
		<div id='labelprimary'>[[labelprimary]]</div>
		<div id='labelsecondary'>[[labelsecondary]]</div>
		<div id="editOverlay">
            <div class="buttons">
                <button id="editWidget" on-click="editWidget" class="editWidget" aria-label="Edit"><i class="fa fa-cog" aria-hidden="true"></i></button>
                <button id="removeWidget" on-click="removeWidget" class="removeWidget" aria-label="Remove"><i class="fa fa-times" aria-hidden="true"></i></button>
            </div>
            <paper-tooltip for="editOverlay" class="tipsize" offset="-50">
                <div class="info">
                    <span>{{localize("widget:min")}} : <span id="minSize"></span></span>
                    <span>{{localize("widget:max")}} : <span id="maxSize"></span></span>
                </div>
            </paper-tooltip>
		</div>
		<div id="timeoutOverlay"></div>
	</template>
	<script>
        class DmwWidget extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.GestureEventListeners(Polymer.Element)) {
            static get is () { return 'dmw-widget'; }
            static get properties() {
                return {
                    /* Overriden from AppLocalizeBehavior */
                    language: {
                        value: navigator.language || navigator.userLanguage || navigator.browserLanguage || navigator.systemLanguage,
                        type: String
                    },
                    instanceid: {
                        type: Number,
                        notify: true,
                        observer: '_instanceidChanged'
                    },
                    edit: {
                        notify: true,
                        observer: '_editChanged',
                        reflectToAttribute: true
                    },
                    debug: {
                        notify: true
                    },
                    default_style: {
                        notify: true
                    }
                }
            }
            constructor() {
                super();
                // For AppLocalizeBehavior : if the translation does not exist retourn the key
                this.useKeyIfMissing = true;
                this.loadResources(this.resolveUrl('/locales/domoweb/'+this.language+'/translation.json'),this.language);
                this.loadResources(this.resolveUrl('locales/'+this.language+'/translation.json'), this.language, true);
                this._languageLoaded = -2;
                this.ratioConstraint = ""; // used "" for no constraint, "width" to constraint witdh, "height" to constraint height
                this.addEventListener("app-localize-resources-loaded", this._handleLangLoad.bind(this));
                this.addEventListener("app-localize-resources-error", this._handleLangLoad.bind(this));
            }
            connectedCallback() {
                super.connectedCallback();
                this._setResizer();
                this.sensorlost = null;
                this.historylost = null;
                this.sensorsReady = false;
                this.commandsReady = false;
                this.devicesReady = false;
                this.loaded = false;
                this._ajaxEditEvent = false;
                this._timeoutEvents = [];
                this._computeScale();
                 // Memorize style attribute modified by the-grid
                this.MemZindex = this.style.zIndex;
                this.MemTransition = this.style.transition;
                this.resized()
                if (this.datatypes === null || this.datatypes === undefined) {
                    document.querySelector("dmw-datatypes").addEventListener("datatype-received", this.datatypesReceived.bind(this), false);
                }
            }
            disconnectedCallback () {
                super.connectedCallback();
                this._removeTimeoutEvents();
            }
            _computeScale() {
                const cellHeight = this.parentNode.getAttribute('cell-height'),
                    cellWidth = this.parentNode.getAttribute('cell-width'),
                    cellMargin = this.parentNode.getAttribute('cell-margin'),
                    heightCell = this.getAttribute('height'),
                    widthCell = this.getAttribute('width'),
                    orgHeightCell = this.getAttribute('org-height'),
                    orgWidthCell = this.getAttribute('org-width');
                const height = heightCell * cellHeight + ((heightCell - 1) * cellMargin),
                    width = widthCell * cellWidth + ((widthCell - 1) * cellMargin),
                    orgHeight = orgHeightCell * cellHeight + ((orgHeightCell - 1) * cellMargin),
                    orgWidth = orgWidthCell * cellWidth + ((orgWidthCell - 1) * cellMargin);
                const wscaleH = height / orgHeight,
                    wscaleW = width / orgWidth,
                    orgRatio = orgWidth /orgHeight,
                    ratio = width /height;
                let ratioScale;
                switch (this.ratioConstraint) {
                    case 'width':
                        ratioScale = ratio < orgRatio ? ratio/orgRatio : 1;
                        break;
                    case 'height':
                        ratioScale = ratio > orgRatio ? ratio/orgRatio : 1;
                        break;
                    default:
                        ratioScale = ratio/orgRatio;
                }
                this.scales = {'width': wscaleW, 'height': wscaleH, 'currentRatio': ratio, 'orginalRatio': orgRatio, 'constraintRatio': ratioScale};
                this.style.setProperty("--wscale-h", wscaleH);
                this.style.setProperty("--wscale-w", wscaleW);
                this.style.setProperty("--wscale-r", ratioScale);
            }
            loadLanguage(file, path) {
                if(file ==  undefined) file = 'translation.json';
                if (path == undefined) path = 'locales/'+this.language;
                path+='/'
                this.loadResources(this.resolveUrl(path+file), this.language, true);
                this._languageLoaded --;
            }
            _handleLangLoad(event) {
                this._languageLoaded++;
                if (this._languageLoaded == 0) {
                    this.languageLoaded();
                }
            }
            _setResizer() {
                var minWidth = parseInt(this.getAttribute('min-width')),
                    maxWidth = parseInt(this.getAttribute('max-width')),
                    minHeight = parseInt(this.getAttribute('min-height')),
                    maxHeight = parseInt(this.getAttribute('max-height'));
                var resizeW = minWidth < maxWidth ? true : false;
                var resizeH = minHeight < maxHeight ? true : false;
                var newResizers = [];
                if (resizeW) { newResizers.push('<span resize="left">│</span>' , '<span resize="right">│</span>'); };
                if (resizeH) { newResizers.push('<span resize="top">─</span>', '<span resize="bottom">─</span>'); };
                if (resizeW && resizeH) { newResizers.push('<span resize="top-right">┐</span>' ,
                                                        '<span resize="top-left">┌</span>',
                                                        '<span resize="bottom-right">┘</span>',
                                                        '<span resize="bottom-left">└</span>'); }
                var resizers = this.getResizers();
                while (resizers.length != 0) {
                    this.$.editOverlay.removeChild(resizers[0]);
                }
                for (var i=0; i<newResizers.length; i++) {
                    $(this.$.editOverlay).append(newResizers[i]);
                }
            }
            getResizers(){
                return this.$.editOverlay.querySelectorAll('[resize]') || [];
            }
            removeWidget(e) {
                this.$.socket.send("widgetinstance-remove", {'instance_id':this.instanceid});
            }
            editWidget(e) {
                var self = this;
                var modalOverlay = document.getElementById('modal-overlay');
                if (!this._ajaxEditEvent) {
                    this._ajaxEditEvent = true;
                    this.$.ajax.setAttribute('handleAs', 'text');
                    this.$.ajax.addEventListener("polymer-response",
                        function(e) {
                            var response = e.detail.response;
                            if (response == '{success:true}') {
                                modalOverlay.classList.remove('on');
                                modalOverlay.innerHTML = '';
                            } else {
                                modalOverlay.innerHTML = response;
                                var saveConfig = modalOverlay.querySelector('#saveConfig');
                                var cancelConfig = modalOverlay.querySelector('#cancelConfig');
                                var formConfig = modalOverlay.querySelector('#formConfig');
                                saveConfig.addEventListener("click",
                                    function(e) {
                                        self.$.ajax.setAttribute('body', $(formConfig).serialize());
                                        self.$.ajax.setAttribute('method', 'POST');
                                        self.$.ajax.setAttribute('params', '{"action":"widget", "id":"' + self.instanceid + '"}');
                                        self.$.ajax.go();
                                        e.preventDefault();
                                        e.stopPropagation();
                                        return false;
                                    });
                                cancelConfig.addEventListener("click",
                                    function(e) {
                                        modalOverlay.classList.remove('on');
                                        modalOverlay.innerHTML = '';
                                        e.preventDefault();
                                        e.stopPropagation();
                                        return false;
                                    });
                                modalOverlay.classList.add('on');

                                $("fieldset[data-toggle=fieldset]").each(function() {
                                    var $this = $(this);

                                    //Add new entry
                                    $this.find("button[data-toggle=fieldset-add-row]").click(function() {
                                        var target = $($(this).data("target"))
                                        var oldrow = target.find("div[data-toggle=fieldset-entry]:last");
                                        var row = oldrow.clone(true, true);
                                        var elem_id = row.find(":input")[0].id;
                                        var reg = /.*-(\d{1,2})/m;
                                        var elem_num = parseInt(reg.exec(elem_id)[1]) + 1;
                                        row.attr('data-id', elem_num);
                                        row.find(":input").each(function() {
                                            var id = $(this).attr('id').replace('-' + (elem_num - 1), '-' + (elem_num));
                                            $(this).attr('name', id).attr('id', id).val('').removeAttr("checked");
                                        });
                                        row.find("label").each(function() {
                                            var idfor = $(this).attr('for').replace('-' + (elem_num - 1), '-' + (elem_num));
                                            $(this).attr('for', idfor);
                                            $(this).text("#"+(elem_num+1));
                                        });
                                        oldrow.after(row);
                                        var length = target.find("div[data-toggle=fieldset-entry]").length;
                                        if (length == $this.data("maxgroup")) {
                                            $this.find("button[data-toggle=fieldset-add-row]").attr('disabled', 'disabled');
                                        }
                                        if (length > $this.data("mingroup")) {
                                            $this.find("button[data-toggle=fieldset-remove-row]").removeAttr('disabled');
                                        }
                                    }); //End add new entry

                                    //Remove row
                                    $this.find("button[data-toggle=fieldset-remove-row]").click(function() {
                                        var target = $($(this).data("target"))
                                        var row = target.find("div[data-toggle=fieldset-entry]:last");
                                        row.remove();
                                        var length = target.find("div[data-toggle=fieldset-entry]").length;
                                        if (length == $this.data("mingroup")) {
                                            $this.find("button[data-toggle=fieldset-remove-row]").attr('disabled', 'disabled');
                                        }
                                        if (length < $this.data("maxgroup")) {
                                            $this.find("button[data-toggle=fieldset-add-row]").removeAttr('disabled');
                                        }
                                    }); //End remove row
                                });
                            }
                        });
                }
                this.$.ajax.setAttribute('method', 'GET');
                this.$.ajax.setAttribute('params', '{"action":"widget", "id":"' + this.instanceid + '"}');
                self.$.ajax.go();
            }
            _instanceidChanged(newValue, oldValue) {
                this.$.socket.register('widgetinstance-options', this.optionsReceived.bind(this), {'instance_id': newValue});
                this.$.socket.send("widgetinstance-getoptions", {'instance_id': newValue});
            }
            datatypesReceived() {
                if (!this.loaded && this.options) this.initialStepReady();
            }
            optionsReceived(topic, json) {
                this.options = json['options'];
                if (this.default_style!=null) {
                  this.style.color=this.options['WidgetTextColor'];
                  this.style.backgroundColor=this.options['WidgetBackgroundColor'];
                  this.style.borderColor=this.options['WidgetBorderColor'];
                  this.style.borderRadius=this.options['WidgetBorderRadius'];
                  this.style.boxShadow=this.options['WidgetBoxShadow'];
                }
                this.optionsUpdated();
                if (!this.loaded && this.datatypes) this.initialStepReady();
            }
            initialStepReady() {
                this.$.socket.register('widgetinstance-sensors', this.sensorsReceived.bind(this), {'instance_id': this.instanceid});
                this.$.socket.send("widgetinstance-getsensors", {'instance_id': this.instanceid});
                this.$.socket.register('widgetinstance-commands', this.commandsReceived.bind(this), {'instance_id': this.instanceid});
                this.$.socket.send("widgetinstance-getcommands", {'instance_id': this.instanceid});
                this.$.socket.register('widgetinstance-devices', this.devicesReceived.bind(this), {'instance_id': this.instanceid});
                this.$.socket.send("widgetinstance-getdevices", {'instance_id': this.instanceid});
                DMW.main.layout.refreshEventResizer(this, false)
                this.$.minSize.innerHTML = this.getAttribute('min-width') + " x " + this.getAttribute('min-height');
                this.$.maxSize.innerHTML = this.getAttribute('max-width') + " x " + this.getAttribute('max-height');
            }
            _addTimeoutEvent(dmwsensor, event, callback) {
                let find = false;
                for (let i=0; i < this._timeoutEvents.length; i++) {
                    if (this._timeoutEvents[i].dmwsensor == dmwsensor && this._timeoutEvents[i].event == event) {
                        find = true;
                        break;
                    }
                }
                if (!find) {
                    dmwsensor.addEventListener(event, callback);
                    this._timeoutEvents.push({'dmwsensor': dmwsensor, 'event': event, 'callback': callback});
                }
            }
            _addTimeoutEvents(dmwsensor) {
                this._addTimeoutEvent(dmwsensor, "sensor-timeout", this.timeoutDetected.bind(this));
                this._addTimeoutEvent(dmwsensor, "sensor-timeoutend", this.timeoutFinished.bind(this));
                this._addTimeoutEvent(dmwsensor, "sensor-history-timeout", this.timeoutHistoryDetected.bind(this));
                this._addTimeoutEvent(dmwsensor, "sensor-history-timeoutend", this.timeoutHistoryFinished.bind(this));
            }
            _removeTimeoutEvents() {
                let e;
                for (let i=0; i < this._timeoutEvents.length; i++) {
                    e = this._timeoutEvents[i];
                    e.dmwsensor.removeEventListener(e.event, e.callback);
                }
                this._timeoutEvents = [];
            }
            sensorsReceived(topic, json) {
                this._removeTimeoutEvents();
                for (var key in json['sensors']) {
                    var sensor = json['sensors'][key];
                    var dmwsensor = this.shadowRoot.querySelector('dmw-sensor[sensorkey="' + key + '"]');
                    if (dmwsensor) {
                        if (this.options['WidgetSensorTimeout'] == 1) this._addTimeoutEvents(dmwsensor);
                        dmwsensor.init(sensor);
                    }
                }
                this.sensorsUpdated();
                if (!this.loaded) { // First loading
                    this.sensorsReady = true;
                    if (this.commandsReady && this.devicesReady) this.loadingReady();
                }
            }
            commandsReceived(topic, json) {
                for (var key in json['commands']) {
                    var command = json['commands'][key];
                    var dmwcommand = this.shadowRoot.querySelector('dmw-command[commandkey="' + key + '"]');
                    if (dmwcommand) {
                        dmwcommand.init(command);
                    }
                }
                this.commandsUpdated();
                if (!this.loaded) { // First loading
                    this.commandsReady = true;
                    if (this.sensorsReady && this.devicesReady) this.loadingReady();
                }
            }
            devicesReceived(topic, json) {
                for (var key in json['devices']) {
                    var device = json['devices'][key];
                    if ('sensors' in device) {
                        for (var key in device['sensors']) {
                            var dmwsensor = this.shadowRoot.querySelector('dmw-sensor[sensorkey="' + key + '"]');
                            if (dmwsensor) {
                                dmwsensor.init(device['sensors'][key]);
                                if (this.options['WidgetSensorTimeout'] == 1) this._addTimeoutEvents(dmwsensor);
                            }
                        }
                    }
                    if ('commands' in device) {
                        for (var key in device['commands']) {
                            var dmwcommand = this.shadowRoot.querySelector('dmw-command[commandkey="' + key + '"]');
                            if (dmwcommand) {
                                dmwcommand.init(device['commands'][key]);
                            }
                        }
                    }
                }
                this.devicesUpdated();
                if (!this.loaded) { // First loading
                    this.devicesReady = true;
                    if (this.commandsReady && this.sensorsReady) this.loadingReady();
                }
            }
            get datatypes() {
                var datatypes = document.querySelector("dmw-datatypes");
                return datatypes.list;
            }
            loadingReady() {
                this.classList.remove('loading');
                this.loaded = true;
                this.loadingDone();
            }
            loadingDone() {}
            sensorsUpdated() {}
            commandsUpdated() {}
            devicesUpdated() {}
            optionsUpdated() {}
            languageLoaded() {}
            resized() {}
            adjustText(parent, element, margin = {width :0, height:0}) {
                if (parent.clientWidth == 0 || parent.clientHeight == 0 || element.offsetWidth == 0) {
                    // in case the page is not yet nicely loaded...
                    setTimeout(function(){
                        this.adjustText(parent, element, margin);
                        }.bind(this), 1000);
                } else {
                    let i = 100; // force highSize to recalculate;
                    element.style.fontSize = i+"px";
                    const maxWith = parent.clientWidth - margin.width;
                    const maxHeight = parent.clientHeight - margin.height;
                    if (maxWith > element.offsetWidth && maxHeight > element.offsetHeight) {
                        while ( maxWith > element.offsetWidth && maxHeight > element.offsetHeight && i < 100){
                            element.style.fontSize = i+"px";
                            i++;
                        }
                    } else if (element.offsetWidth > maxWith || element.offsetHeight > maxHeight ) { // If text is bigger than widget
                        while ((element.offsetWidth > maxWith || element.offsetHeight > maxHeight) && i > 5){
                            element.style.fontSize = i+"px";
                            i--;
                        }
                    }
                }
            }
            timeoutDetected(e) {
                this.sensorlost = e.target;
                var text = this.localize("widget:sensorLost");
                if (e.detail.minutes) {
                    text += "<br/>" + e.detail.minutes;
                }
                this.$.timeoutOverlay.innerHTML = text;
                this.$.timeoutOverlay.style.display = 'block';
            }
            timeoutFinished(e) {
                if (this.sensorlost && e.target.id == this.sensorlost.id) {
                    this.sensorlost = null;
                    this.$.timeoutOverlay.style.display = 'none';
                }
            }
            timeoutHistoryDetected(e) {
                this.historylost = e.target;
                this.resources;
                var text = this.localize("widget:historyRequestTimeout");
                if (e.detail.comment) {
                    text += "<br/>" + this.localize("widget:"+e.detail.comment);
                }
                this.$.timeoutOverlay.innerHTML = text;
                this.$.timeoutOverlay.style.display = 'block';
            }
            timeoutHistoryFinished(e) {
                if (this.historylost && e.target.id == this.historylost.id) {
                    this.historylost = null;
                    this.$.timeoutOverlay.style.display = 'none';
                }
            }
            _editChanged(newValue, oldValue) {
                const editOverlay = this.$.editOverlay;

                if (newValue != null) {
                    // Memorize style attribute modified by the-grid
                    this.MemZindex = this.style.zIndex;
                    this.MemTransition = this.style.transition;
                    // Show config overlay
                    editOverlay.classList.add('visible');
                } else {
                    // Hide config overlay
                    editOverlay.classList.remove('visible');
                    // Restore style attribute modified by the-grid
                    this.style.zIndex = this.MemZindex;
                    this.style.transition = this.MemTransition;
                }
            }
        };
	function createStyle(id, css) {
		var existingstyle = document.querySelector('style#style-instance-'+id);
		if (existingstyle) existingstyle.remove();
		var style = document.createElement('style');
		style.id = "style-instance-"+id;
		style.type = "text/css";
		// WebKit hack
		if (style.styleSheet){
			style.styleSheet.cssText = css;
		} else {
			style.appendChild(document.createTextNode(css));
		}
		document.head.appendChild(style);
		return style;
    };
    customElements.define(DmwWidget.is, DmwWidget);
    </script>
</dom-module>

